icon: https://github.com/okteto/polling/raw/master/icon.png
deploy:
  - envsubst < kustomize/overlays/okteto/deployment.tmpl.yaml > kustomize/overlays/okteto/deployment.yaml

  - okteto build -f ./Dockerfile.okteto -t okteto.dev/replicated-kurl-dist-server:${OKTETO_GIT_COMMIT} .
  - okteto build -f ./web/Dockerfile.okteto -t okteto.dev/replicated-kurl:${OKTETO_NAMESPACE} .

  - cd kustomize/overlays/okteto && kustomize edit set image replicated/kurl-dist-server=okteto.dev/replicated-kurl-dist-server:${OKTETO_GIT_COMMIT}
  - cd kustomize/overlays/okteto && kustomize edit set image replicated/kurl=okteto.dev/replicated-kurl:${OKTETO_NAMESPACE}

  - kubectl apply -k kustomize/overlays/okteto

  ## Test Grid
  - envsubst < testgrid/migrations/kustomize/overlays/okteto/testgrid-postgres.tmpl.yaml > testgrid/migrations/kustomize/overlays/okteto/testgrid-postgres.yaml
  - envsubst < testgrid/tgapi/kustomize/overlays/okteto/deployment.tmpl.yaml > testgrid/tgapi/kustomize/overlays/okteto/deployment.yaml

  - okteto build -f ./testgrid/migrations/Dockerfile.okteto -t okteto.dev/replicated-tgdb:${OKTETO_GIT_COMMIT} .
  - okteto build -f ./testgrid/tgapi/Dockerfile.okteto -t okteto.dev/replicated-tgapi:${OKTETO_GIT_COMMIT} .
  - okteto build -f ./testgrid/web/Dockerfile.okteto -t okteto.dev/replicated-tgweb:${OKTETO_NAMESPACE} .

  - cd testgrid/kustomize/overlays/okteto && kustomize edit set image tgdb=okteto.dev/replicated-tgdb:${OKTETO_GIT_COMMIT}
  - cd testgrid/kustomize/overlays/okteto && kustomize edit set image tgapi=okteto.dev/replicated-tgapi:${OKTETO_GIT_COMMIT}
  - cd testgrid/kustomize/overlays/okteto && kustomize edit set image tgweb=okteto.dev/replicated-tgweb:${OKTETO_NAMESPACE}

  - kubectl apply -k testgrid/kustomize/overlays/okteto

devs:
  - okteto.yml
  - web/okteto.yml
  - testgrid/migrations/okteto.yml
  - testgrid/tgapi/okteto.yml
  - testgrid/web/okteto.yml
